# Лабораторная работа №4: бинаризация и простое детектирование объектов

## Введение
Цель работы - реализовать генерацию тестовых изображений, состоящих из круго различной яркости и радиуса. Применить к изображению размытие, добавить аддитивный гауссовский шум. Каждое изображение должно иметь JSON файл разметки с параметрами координат, радиусов кругов, размеры итоговоого изображения, цвет, blur и std фона.

Реализовать детектор объектов на основе адаптивной бинаризации и разделению по компонентам связности. 

Реализовать подсчет качества выполненной детекции.


## Реализация

### Генерация тестовых изображений
Функция `generateImageWithCircles()  
генерирует изображение с следующими параметрами:
int count - количество кругов в строке;
int min_radius - минимальный радиус круга;
int max_radius - максимальный радиус круга;
int min_contrast - минимальная яркость круга;
int max_contrast - максимальная яркость круга;
double std - стандартное отклонение нормального аддитивного гауссовского шума;
int blur - параметр размытия;
 bool bSave - сохранять/не сохранять в файл итоговое изображение;

### Детекция (адаптивная бинаризация и компоненты связности)
Функции `makeAdaptiveBinarization()` и `connectedComponentsDetection()` Применим алгоритм бинаризации и затем поиск компонент связности. Компонентыы связности отфильтруем по размеру, обычно он известен из предметной области.

### Детекция (LoG)
`LoG()`

### Подсчет качества детекции
Для каждого объекта ground truth вычисляем IoU `IoU()` с полученными после детекции объектами. Считаем показатели TP, FP и FN `evaluateDetections()`


## Ход работы
1. Сгенерируем изображение со следующими параметрами:

| Параметр | Значение |
|---|---|
| Количество кругов | 100 |
| Минимальный радиус | 2 |
| Максимальный радиус | 31 |
| Минимальный контраст | 36 |
| Максимальный контраст | 219 |
| Std шума | 22 |
| Blur | 2 |


| Сгенерированное изображение |Детекция бинаризация + компоненты связности |
|----------------------|----------------|
| ![](https://github.com/zhuzzzhha/misis2024s-21-03-zhukova-a-v/blob/main/images/lab_1/generated.png) | ![](https://github.com/zhuzzzhha/misis2024s-21-03-zhukova-a-v/blob/main/images/lab_1/connected_comps.png) |

2. К изображению применим адаптивную бинаризацию с помощью функции OpenCV `makeAdaptiveBinarization()` с параметром `max_value = 255`. Установка `max_value` равным 255 гарантирует, что выходное изображение будет иметь значения пикселей в том же диапазоне, что и входное изображение.

3. Найдем компоненты свзяности бинаризованного изображения с помощью функции `connectedComponentsWithStats()`, указав в параметре connectivity 8.
4. Отфильтруем компоненты по размеру, указанном в параметре `areaThreshold`
5. Вычислим IoU для каждой окружности и с учетом порога для IoU вычислим TP, FP, FN.

Проведем эксперименты, изменяя значения порога для компонент свзяности и IoU: 


| IoU пороговое значение | Порог для компонент связности (areaThreshold) | TP | FP | FN |
|---|---|---|---|---|
| 10 | 4 | 13 | 11749 | 87 |
| 10 | 30 | 15 | 2471 | 85 |
| 10 | 50 | 16 | 1242 | 84 |
| 10 | 60 | 18 | 922 | 82 |
| 10 | 70 | 8 | 721 | 92 |
| 10 | 100 | 8 | 344 | 92 |
| 10 | 120 | 7 | 248 | 93 |
| 10 | 150 | 9 | 144 | 91 |
| 20 | 4   |16 |11768| 84 |
| 20 | 30  |16 | 2338| 84 |
| 20 | 50  |14 | 1221| 86 |
| 20 | 60  | 8 | 901 | 92 |
| 20 | 70  | 10| 709 | 90 |
| 20 | 100 | 6 | 362 | 94 |
| 20 | 120 | 5 | 236 | 95 |
| 20 | 150 | 4 | 138 | 96 |

|Детекция бинаризация + компоненты связности |Порог для компонент свзяности (areaThreshold) |Порог для IoU | 
|-------------|--|--|
| ![](https://github.com/zhuzzzhha/misis2024s-21-03-zhukova-a-v/blob/main/images/lab_1/connected_comps_4.png) |4 |  10 |
| ![](https://github.com/zhuzzzhha/misis2024s-21-03-zhukova-a-v/blob/main/images/lab_1/connected_comps_30.png) |30 |  10 |
| ![](https://github.com/zhuzzzhha/misis2024s-21-03-zhukova-a-v/blob/main/images/lab_1/connected_comps_50.png) |50 |  10 |
| ![](https://github.com/zhuzzzhha/misis2024s-21-03-zhukova-a-v/blob/main/images/lab_1/connected_comps_60.png) |60 |  10 |
| ![](https://github.com/zhuzzzhha/misis2024s-21-03-zhukova-a-v/blob/main/images/lab_1/connected_comps_70.png) |70 |  10 |
| ![](https://github.com/zhuzzzhha/misis2024s-21-03-zhukova-a-v/blob/main/images/lab_1/connected_comps_100.png) |100 |  10 |
| ![](https://github.com/zhuzzzhha/misis2024s-21-03-zhukova-a-v/blob/main/images/lab_1/connected_comps_120.png) |120 |  10 |
| ![](https://github.com/zhuzzzhha/misis2024s-21-03-zhukova-a-v/blob/main/images/lab_1/connected_comps_150.png) |150 |  10 |


## Вывод
С увеличением порога для компонент свзяности мы снизили количество ложноположительно затедектированных оркужностей. При этом значение истинно положительных снизилось, достигнув своего пика при пороге 60. С увеличением порога IoU TP и FP снизилось. В ходе работы удалось выяснить, что порог для компонент свзяности и IoU стоит выявлять эмпирически, с учетом особенностей входных изображений.

